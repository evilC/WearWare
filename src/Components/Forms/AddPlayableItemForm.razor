@inject IJSRuntime JS
@using WearWare.Common.Media
@using WearWare.Services.Library

@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("import", "/js/ScrollbarHider.js");
            await JS.InvokeVoidAsync("modalScrollLock.lock");
        }
    }

    public async ValueTask DisposeAsync()
    {
        await JS.InvokeVoidAsync("modalScrollLock.unlock");
    }
    [Parameter] public IReadOnlyList<LibraryItem>? LibraryItems { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public EventCallback<(int insertIndex, LibraryItem libItem, PlayMode playMode, int playModeValue, int relativeBrightness)> OnAdd { get; set; }
    [Parameter] public int InsertIndex { get; set; }
    [Parameter] public string PageTitle { get; set; } = "Playlist";

    private Dictionary<string, int> playModeOptions = new()
    {
        { "Loop", (int)PlayMode.LOOP },
        { "Duration", (int)PlayMode.DURATION },
        { "Forever", (int)PlayMode.FOREVER }
    };

    private int selectedPlayMode = (int)PlayMode.LOOP;
    private int selectedPlayModeValue = 1;
    private int selectedRelativeBrightness = 100;
    private LibraryItem? selectedLibraryItem;

    private void OnSelectPlayMode(int value)
    {
        selectedPlayMode = value;
        if (selectedPlayMode == (int)PlayMode.FOREVER)
        {
            selectedPlayModeValue = 1;
        }
    }

    private void OnSelectPlayModeValue(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var v))
            selectedPlayModeValue = v;
    }

    private void SelectItem(LibraryItem libItem)
    {
        selectedLibraryItem = libItem;
        selectedRelativeBrightness = libItem.RelativeBrightness;
    }

    private void AddOk()
    {
        if (selectedLibraryItem != null)
        {
            OnAdd.InvokeAsync((InsertIndex, selectedLibraryItem, (PlayMode)selectedPlayMode, selectedPlayModeValue, selectedRelativeBrightness));
        }
    }

    public async Task UnlockScrollAsync()
    {
        await JS.InvokeVoidAsync("modalScrollLock.unlock");
    }
}

<div class="add-dialog" @onclick="() => OnCancel.InvokeAsync(null)">
    <div class="add-dialog__content" @onclick:stopPropagation>
        <h2>Add @PageTitle</h2>
        <div class="add-dialog-row">
            <div class="add-dialog-section">
                <div class="add-dialog-options">
                    @foreach (var mode in playModeOptions)
                    {
                        <label class="add-dialog-radio-label">
                            <span class="add-dialog-mode-text">@mode.Key</span>
                            <input type="radio" name="playMode" value="@mode.Value" @onchange="() => OnSelectPlayMode(mode.Value)" checked="@(selectedPlayMode == mode.Value)" class="add-dialog-radio" />
                        </label>
                    }
                </div>
            </div>
            <div class="add-dialog-section">
                <label class="add-dialog-label">Value</label>
                <input type="number" class="add-dialog-number" value="@selectedPlayModeValue" min="1" max="100" disabled="@(selectedPlayMode == (int)PlayMode.FOREVER)" @onchange="OnSelectPlayModeValue" />
            </div>
        </div>
        @if (LibraryItems is null || !LibraryItems.Any())
        {
            <div>No items found.</div>
        }
        else
        {
            <div class="add-dialog__list">
                <ul>
                    @foreach (var libItem in LibraryItems)
                    {
                        var itemClass = selectedLibraryItem == libItem ? "add-dialog__item add-dialog__item--selected" : "add-dialog__item";
                        <li class="@itemClass" @onclick="() => SelectItem(libItem)">
                            <img class="add-dialog__item-image" src="/library-image/@libItem.SourceFileName" alt="@libItem.Name" />
                            <div>
                                <strong>@libItem.Name</strong><br />
                                <span class="add-dialog__item-type">@libItem.MediaType</span>
                            </div>
                        </li>
                    }
                </ul>
            </div>
            <div class="add-dialog-row" style="margin-top:1rem;">
                <label class="add-dialog-label">Relative Brightness (%)
                    <input type="number" class="add-dialog-number" @bind="selectedRelativeBrightness" @bind:event="oninput" min="1" max="100" />
                </label>
            </div>
            <div style="display:flex; gap:0.5rem; justify-content:center; margin-top:0.5rem;">
                <button type="button" class="add-dialog__cancel-button" @onclick="AddOk" disabled="@(selectedLibraryItem == null)">OK</button>
                <button type="button" @onclick="() => OnCancel.InvokeAsync(null)" class="add-dialog__cancel-button">Cancel</button>
            </div>
        }
    </div>
</div>
