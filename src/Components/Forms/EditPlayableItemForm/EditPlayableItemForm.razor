@using WearWare.Common.Media
@using WearWare.Common
@using WearWare.Components.Forms.MatrixOptionsForm
@rendermode InteractiveServer

@* Main Razor Markup: *@
@if (FormModel is not null)
{
    <div class="edit-dialog" @onclick="() => OnCancel.InvokeAsync(null)">
        <div class="edit-dialog__content" @onclick:stopPropagation>
            <h4>@BuildPageTitle()</h4>
            @if(FormModel.FormMode == EditPlayableItemFormMode.ReConvertAllMatrix)
            {
                <div style ="margin-bottom:1rem;">
                    <span>ReConverts all @FormModel.FormPage items with their Relative Brightness and the selected Matrix Options (Defaults to the Global Matrix options)</span>
                </div>
            }
            else if(FormModel.FormMode == EditPlayableItemFormMode.ReConvertAllBrightness)
            {
                <div style ="margin-bottom:1rem;">
                    <span>ReConverts all @FormModel.FormPage items with a new Relative Brightness and their embedded Matrix Options</span>
                </div>
            }
            @if (FormModel.FormPage == EditPlayableItemFormPage.Import)
            {
                <div class="add-dialog-row" style="margin-top:0.5rem; margin-bottom:1rem;">
                    <EditForm Model="importNameModel">
                        <DataAnnotationsValidator />
                        <label class="add-dialog-label">Name
                            <InputText class="add-dialog-number" style="width: 20rem; border-radius: 6px;" @bind-Value="importNameModel.Name" />
                        </label>
                        <ValidationMessage For="@(() => importNameModel.Name)" />
                    </EditForm>
                </div>
            }
            @if (FormModel.FormPage != EditPlayableItemFormPage.Library && FormModel.FormPage != EditPlayableItemFormPage.Import && 
                FormModel.FormMode != EditPlayableItemFormMode.ReConvertAllMatrix && FormModel.FormMode != EditPlayableItemFormMode.ReConvertAllBrightness)
            {
                <div class="add-dialog-row">
                    <div class="add-dialog-section">
                        <div class="add-dialog-options">
                            @foreach (PlayMode playMode in Enum.GetValues(typeof(PlayMode)))
                            {
                                <label class="add-dialog-radio-label">
                                    <span class="add-dialog-mode-text">@playMode.ToString()</span>
                                    <input type="radio" name="editPlayMode" value="@((int)playMode)" @onchange="() => FormModel.UpdatedItem.PlayMode = playMode" checked="@(selectedPlayMode == (int)playMode)" class="add-dialog-radio" />
                                </label>
                            }
                        </div>
                    </div>
                    <div class="add-dialog-section">
                        <label class="add-dialog-label">Value</label>
                        <input type="number" class="add-dialog-number"
                            value="@FormModel.UpdatedItem.PlayModeValue" min="1" max="100"
                            disabled="@(FormModel.UpdatedItem.PlayMode == PlayMode.Forever)"
                            @onchange="e => FormModel.UpdatedItem.PlayModeValue = int.TryParse(Convert.ToString(e.Value), out var v) ? v : 1"
                        />
                    </div>
                </div>
            }
            @if (FormModel.FormMode != EditPlayableItemFormMode.ReConvertAllMatrix && FormModel.FormMode != EditPlayableItemFormMode.ReConvertAllBrightness){
                <div class="add-dialog__list">
                    <div style="display:flex; align-items:center; gap:1rem;">
                        <img class="add-dialog__item-image" src="@FormModel.ImageUrl" alt="@EditingItem?.Name" />
                        <div>
                            <strong>@EditingItem?.Name</strong><br />
                            <span class="add-dialog__item-type">@EditingItem?.MediaType</span>
                        </div>
                    </div>
                </div>
                <div class="add-dialog-row" style="margin-top: 1em;">
                    <label class="add-dialog-label">Stream Current Brightness (%)
                        <input type="number" disabled class="add-dialog-number" @bind="streamCurrentBrightness"/>
                    </label>
                </div>
            }
            @if (FormModel.FormMode != EditPlayableItemFormMode.ReConvertAllMatrix){
                <div class="add-dialog-row">
                    <label class="add-dialog-label">Relative Brightness (%)
                        <input type="number" class="add-dialog-number" @bind="SelectedRelativeBrightness" @bind:event="oninput" min="1" max="100" />
                    </label>
                </div>
            }
            @if (FormModel.FormMode != EditPlayableItemFormMode.ReConvertAllMatrix && FormModel.FormMode != EditPlayableItemFormMode.ReConvertAllBrightness){
                <div class="add-dialog-row">
                    <label class="add-dialog-label">Adjusted Brightness (%)
                        <input type="number" disabled class="add-dialog-number" @bind="adjustedBrightness" @bind:event="oninput" min="1" max="100" />
                    </label>
                </div>
            }
            @if (FormModel.FormMode != EditPlayableItemFormMode.ReConvertAllBrightness)
            {
                <button type="button" class="add-dialog__cancel-button" @onclick="ShowMatrixOptions">Matrix Options</button>
            }
            <div style="margin-top:0.75rem; display:flex; gap:0.5rem; justify-content:center; width:100%; flex-direction:column; align-items:center;">
                <div style="display:flex; gap:0.5rem;">
                    <button type="button" class="add-dialog__cancel-button" @onclick="() => OnCancel.InvokeAsync(null)">Cancel</button>
                    <button type="button" class="add-dialog__cancel-button" @onclick="SaveEdit">OK</button>
                </div>
            </div>
        </div>
    </div>
}

@* Matrix Options form *@
@if (FormModel is not null && showMatrixOptionsForm && selectedMatrixOptions is not null)
{
    <div style="position:fixed; z-index:9999; inset:8% 10%; display:flex; align-items:flex-start; justify-content:center;">
            <div style="width:80%;">
            <MatrixOptionsForm
                Options="selectedMatrixOptions.Clone()"
                Visibility="MatrixConfigService.Visibility"
                RelativeBrightness="selectedRelativeBrightness"
                HideRelativeBrightness="FormModel.FormMode == EditPlayableItemFormMode.ReConvertAllMatrix"
                OnValidSubmit="OnMatrixOptionsOk"
                OnCancel="OnMatrixOptionsCancel"
                Action="OK"
                Title="@BuildMatrixOptionsTitle()" />
        </div>
    </div>
}
