@rendermode InteractiveServer

@using WearWare.Components.Forms

<div class="mw-matrix-options-modal">
    <EditForm EditContext="_editContext" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />

    <div class="card">
        <div class="card-header">
            <h2>@(!string.IsNullOrEmpty(Title) ? Title : $"Matrix Options for {Action}")</h2>
            @if (OnGlobalOptionsForm)
            {
                <span>The checkbox at the start of each row controls whether the option shows on other pages (Import, Library etc)</span>
            }
        </div>
        <div class="card-body">
                @* Processing/result overlay is rendered as a full-window overlay below so it covers the entire form *@
               <div class="mw-matrix-form-fields">
    @if (OnGlobalOptionsForm || (Visibility?.BrightnessEnabled ?? false))
    {
        <div class="mw-field-validation">
            <ValidationMessage For="@(() => Options.Brightness)" />
        </div>
        <FieldWrapper Label="Brightness %" ShowEnableToggle="OnGlobalOptionsForm" VisibilityGetter="@(() => Visibility!.BrightnessEnabled)" VisibilitySetter="@((bool? v) => Visibility!.BrightnessEnabled = v)">
            <InputNumberOnInputNullable class="form-control mw-matrix-input" @bind-Value="Options.Brightness" @bind-Value:event="oninput" placeholder="@($"(Default: {_defaults.Brightness})")" />
        </FieldWrapper>
    }
    @if (!HideRelativeBrightness)
    {
        // Helper fields to show current relative and calculated brightness
        <div class="mw-matrix-form-row">
            <label class="mw-matrix-label">Relative Brightness %</label>
            <input type="number" class="form-control mw-matrix-input" value="@RelativeBrightness" disabled />
        </div>
        <div class="mw-matrix-form-row">
            <label class="mw-matrix-label">Actual Brightness %</label>
            <input type="number" class="form-control mw-matrix-input" value="@ActualBrightness" disabled />
        </div>
    }
    @if (OnGlobalOptionsForm || (Visibility?.ChainLengthEnabled ?? false))
    {
        <div class="mw-field-validation">
            <ValidationMessage For="@(() => Options.ChainLength)" />
        </div>
        <FieldWrapper Label="Chain Length" ShowEnableToggle="OnGlobalOptionsForm" VisibilityGetter="@(() => Visibility!.ChainLengthEnabled)" VisibilitySetter="@((bool? v) => Visibility!.ChainLengthEnabled = v)">
            <InputNumberOnInputNullable class="form-control mw-matrix-input" @bind-Value="Options.ChainLength" @bind-Value:event="oninput" placeholder="@($"(Default: {_defaults.ChainLength})")" />
        </FieldWrapper>
    }

    @if (OnGlobalOptionsForm || (Visibility?.ColsEnabled ?? false))
    {
        <div class="mw-field-validation">
            <ValidationMessage For="@(() => Options.Cols)" />
        </div>
        <FieldWrapper Label="Cols" ShowEnableToggle="OnGlobalOptionsForm" VisibilityGetter="@(() => Visibility!.ColsEnabled)" VisibilitySetter="@((bool? v) => Visibility!.ColsEnabled = v)">
            <InputNumberOnInputNullable class="form-control mw-matrix-input" @bind-Value="Options.Cols" @bind-Value:event="oninput" placeholder="@($"(Default: {_defaults.Cols})")" />
        </FieldWrapper>
    }

    @if (OnGlobalOptionsForm || (Visibility?.DisableHardwarePulsingEnabled ?? false))
    {
        <FieldWrapper Label="Disable Hardware Pulsing" ShowEnableToggle="OnGlobalOptionsForm" VisibilityGetter="@(() => Visibility!.DisableHardwarePulsingEnabled)" VisibilitySetter="@((bool? v) => Visibility!.DisableHardwarePulsingEnabled = v)">
            <InputCheckbox class="form-check-input" @bind-Value="DisableHardwarePulsingChecked" />
        </FieldWrapper>
    }

    @if (OnGlobalOptionsForm || (Visibility?.GpioSlowdownEnabled ?? false))
    {
        <FieldWrapper Label="Gpio Slowdown" ShowEnableToggle="OnGlobalOptionsForm" VisibilityGetter="@(() => Visibility!.GpioSlowdownEnabled)" VisibilitySetter="@((bool? v) => Visibility!.GpioSlowdownEnabled = v)">
            <InputSelect class="form-control mw-matrix-input" TValue="string" @bind-Value="GpioSlowdownSelectValue">
                <option value="0">0</option>
                <option value="">(Default: 1)</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
            </InputSelect>
        </FieldWrapper>
    }

    @if (OnGlobalOptionsForm || (Visibility?.HardwareMappingEnabled ?? false))
    {
        <FieldWrapper Label="Hardware Mapping" ShowEnableToggle="OnGlobalOptionsForm" VisibilityGetter="@(() => Visibility!.HardwareMappingEnabled)" VisibilitySetter="@((bool? v) => Visibility!.HardwareMappingEnabled = v)">
            <InputSelect class="form-control mw-matrix-input" TValue="string" @bind-Value="HardwareMappingSelectValue">
                <option value="">(Default: regular)</option>
                <option value="adafruit-hat">adafruit-hat</option>
                <option value="adafruit-hat-pwm">adafruit-hat-pwm</option>
                <option value="compute-module">compute-module</option>
            </InputSelect>
        </FieldWrapper>
    }

    @if (OnGlobalOptionsForm || (Visibility?.InverseColorsEnabled ?? false))
    {
        <FieldWrapper Label="Inverse Colors" ShowEnableToggle="OnGlobalOptionsForm" VisibilityGetter="@(() => Visibility!.InverseColorsEnabled)" VisibilitySetter="@((bool? v) => Visibility!.InverseColorsEnabled = v)">
            <InputCheckbox class="form-check-input" @bind-Value="InverseColorsChecked" />
        </FieldWrapper>
    }

    @if (OnGlobalOptionsForm || (Visibility?.LedRgbSequenceEnabled ?? false))
    {
        <FieldWrapper Label="Led RGB Sequence" ShowEnableToggle="OnGlobalOptionsForm" VisibilityGetter="@(() => Visibility!.LedRgbSequenceEnabled)" VisibilitySetter="@((bool? v) => Visibility!.LedRgbSequenceEnabled = v)">
            <InputSelect class="form-control mw-matrix-input" TValue="string" @bind-Value="LedRgbSequenceSelectValue">
                <option value="">(Default: RGB)</option>
                <option value="RBG">RBG</option>
                <option value="GRB">GRB</option>
                <option value="GBR">GBR</option>
                <option value="BRG">BRG</option>
                <option value="BGR">BGR</option>
            </InputSelect>
        </FieldWrapper>
    }

    @if (OnGlobalOptionsForm || (Visibility?.LimitRefreshRateHzEnabled ?? false))
    {
        <div class="mw-field-validation">
            <ValidationMessage For="@(() => Options.LimitRefreshRateHz)" />
        </div>
        <FieldWrapper Label="Limit Refresh Rate Hz" ShowEnableToggle="OnGlobalOptionsForm" VisibilityGetter="@(() => Visibility!.LimitRefreshRateHzEnabled)" VisibilitySetter="@((bool? v) => Visibility!.LimitRefreshRateHzEnabled = v)">
            <InputNumberOnInputNullable class="form-control mw-matrix-input" @bind-Value="Options.LimitRefreshRateHz" @bind-Value:event="oninput" placeholder="@($"(Default: {_defaults.LimitRefreshRateHz})")" />
        </FieldWrapper>
    }

    @if (OnGlobalOptionsForm || (Visibility?.MultiplexingEnabled ?? false))
    {
        <FieldWrapper Label="Multiplexing" ShowEnableToggle="OnGlobalOptionsForm" VisibilityGetter="@(() => Visibility!.MultiplexingEnabled)" VisibilitySetter="@((bool? v) => Visibility!.MultiplexingEnabled = v)">
            <InputSelect class="form-control mw-matrix-input" TValue="int" @bind-Value="MultiplexingSelectValue">
                <option value="0">(Default: Direct)</option>
                <option value="1">1 — Stripe</option>
                <option value="2">2 — Checkered</option>
                <option value="3">3 — Spiral</option>
                <option value="4">4 — ZStripe</option>
                <option value="5">5 — ZnMirrorZStripe</option>
                <option value="6">6 — coreman</option>
                <option value="7">7 — Kaler2Scan</option>
                <option value="8">8 — ZStripeUneven</option>
                <option value="9">9 — P10-128x4-Z</option>
                <option value="10">10 — QiangLiQ8</option>
                <option value="11">11 — InversedZStripe</option>
            </InputSelect>
        </FieldWrapper>
    }

    @if (OnGlobalOptionsForm || (Visibility?.PanelTypeEnabled ?? false))
    {
        <FieldWrapper Label="Panel Type" ShowEnableToggle="OnGlobalOptionsForm" VisibilityGetter="@(() => Visibility!.PanelTypeEnabled)" VisibilitySetter="@((bool? v) => Visibility!.PanelTypeEnabled = v)">
            <InputSelect class="form-control mw-matrix-input" TValue="string" @bind-Value="PanelTypeSelectValue">
                <option value="">(Default: HUB75)</option>
                <option value="FM6126A">FM6126A</option>
                <option value="FM6127">FM6127</option>
            </InputSelect>
        </FieldWrapper>
    }

    @if (OnGlobalOptionsForm || (Visibility?.ParallelEnabled ?? false))
    {
        <div class="mw-field-validation">
            <ValidationMessage For="@(() => Options.Parallel)" />
        </div>
        <FieldWrapper Label="Parallel" ShowEnableToggle="OnGlobalOptionsForm" VisibilityGetter="@(() => Visibility!.ParallelEnabled)" VisibilitySetter="@((bool? v) => Visibility!.ParallelEnabled = v)">
            <InputNumberOnInputNullable class="form-control mw-matrix-input" @bind-Value="Options.Parallel" @bind-Value:event="oninput" placeholder="@($"(Default: {_defaults.Parallel})")" />
        </FieldWrapper>
    }

    @if (OnGlobalOptionsForm || (Visibility?.PixelMapperConfigEnabled ?? false))
    {
        <FieldWrapper Label="Pixel Mapper Config" ShowEnableToggle="OnGlobalOptionsForm" VisibilityGetter="@(() => Visibility!.PixelMapperConfigEnabled)" VisibilitySetter="@((bool? v) => Visibility!.PixelMapperConfigEnabled = v)">
            <InputTextOnInput class="form-control mw-matrix-input" @bind-Value="Options.PixelMapperConfig" @bind-Value:event="oninput" placeholder="@($"(Default: {_defaults.PixelMapperConfig})")" />
        </FieldWrapper>
    }

    @if (OnGlobalOptionsForm || (Visibility?.PwmBitsEnabled ?? false))
    {
        <FieldWrapper Label="PWM Bits" ShowEnableToggle="OnGlobalOptionsForm" VisibilityGetter="@(() => Visibility!.PwmBitsEnabled)" VisibilitySetter="@((bool? v) => Visibility!.PwmBitsEnabled = v)">
            <InputNumberOnInputNullable class="form-control mw-matrix-input" @bind-Value="Options.PwmBits" @bind-Value:event="oninput" placeholder="@($"(Default: {_defaults.PwmBits})")" />
        </FieldWrapper>
    }

    @if (OnGlobalOptionsForm || (Visibility?.PwmDitherBitsEnabled ?? false))
    {
        <FieldWrapper Label="PWM Dither Bits" ShowEnableToggle="OnGlobalOptionsForm" VisibilityGetter="@(() => Visibility!.PwmDitherBitsEnabled)" VisibilitySetter="@((bool? v) => Visibility!.PwmDitherBitsEnabled = v)">
            <InputSelect class="form-control mw-matrix-input" TValue="int" @bind-Value="PwmDitherBitsSelectValue">
                <option value="0">(Default: 0)</option>
                <option value="1">1</option>
                <option value="2">2</option>
            </InputSelect>
        </FieldWrapper>
    }

    @if (OnGlobalOptionsForm || (Visibility?.PwmLsbNanosecondsEnabled ?? false))
    {
        <div class="mw-field-validation">
            <ValidationMessage For="@(() => Options.PwmLsbNanoseconds)" />
        </div>
        <FieldWrapper Label="PWM LSB Nanoseconds" ShowEnableToggle="OnGlobalOptionsForm" VisibilityGetter="@(() => Visibility!.PwmLsbNanosecondsEnabled)" VisibilitySetter="@((bool? v) => Visibility!.PwmLsbNanosecondsEnabled = v)">
            <InputNumberOnInputNullable class="form-control mw-matrix-input" @bind-Value="Options.PwmLsbNanoseconds" @bind-Value:event="oninput" placeholder="@($"(Default: {_defaults.PwmLsbNanoseconds})")" />
        </FieldWrapper>
    }

    @if (OnGlobalOptionsForm || (Visibility?.RowAddressTypeEnabled ?? false))
    {
        <FieldWrapper Label="Row Address Type" ShowEnableToggle="OnGlobalOptionsForm" VisibilityGetter="@(() => Visibility!.RowAddressTypeEnabled)" VisibilitySetter="@((bool? v) => Visibility!.RowAddressTypeEnabled = v)">
            <InputSelect class="form-control mw-matrix-input" TValue="int" @bind-Value="RowAddressTypeSelectValue">
                <option value="0">(Default: 0)</option>
                <option value="1">1 — AB</option>
                <option value="2">2 — Direct row select</option>
                <option value="3">3 — ABC</option>
                <option value="4">4 — ABC Shift + DE direct</option>
                <option value="5">5 — ABC Alternate</option>
            </InputSelect>
        </FieldWrapper>
    }

    @if (OnGlobalOptionsForm || (Visibility?.RowsEnabled ?? false))
    {
        <div class="mw-field-validation">
            <ValidationMessage For="@(() => Options.Rows)" />
        </div>
        <FieldWrapper Label="Rows" ShowEnableToggle="OnGlobalOptionsForm" VisibilityGetter="@(() => Visibility!.RowsEnabled)" VisibilitySetter="@((bool? v) => Visibility!.RowsEnabled = v)">
            <InputNumberOnInputNullable class="form-control mw-matrix-input" @bind-Value="Options.Rows" @bind-Value:event="oninput" placeholder="@($"(Default: {_defaults.Rows})")" />
        </FieldWrapper>
    }

    @if (OnGlobalOptionsForm || (Visibility?.ScanModeEnabled ?? false))
    {
        <FieldWrapper Label="Scan Mode" ShowEnableToggle="OnGlobalOptionsForm" VisibilityGetter="@(() => Visibility!.ScanModeEnabled)" VisibilitySetter="@((bool? v) => Visibility!.ScanModeEnabled = v)">
            <InputSelect class="form-control mw-matrix-input" TValue="int" @bind-Value="ScanModeSelectValue">
                <option value="0">(Default: Progressive)</option>
                <option value="1">1 — Interlaced</option>
            </InputSelect>
        </FieldWrapper>
    }

    @* led-image-viewer args preview *@
    </div>
        </div>

        <div class="card-footer text-end">
            <div class="mw-args-preview-inline mb-2">
                <label class="mw-matrix-label mw-args-inline-label">CLI Arguments Preview</label>
                <textarea class="form-control mw-args-preview-textarea" rows="2" readonly>@ArgsPreview</textarea>
            </div>
            <button type="button" class="btn btn-secondary me-2" @onclick="HandleOk">Cancel</button>
            <button type="submit" class="btn btn-primary" disabled="@_hasValidationErrors">@Action</button>
        </div>
    </div>

    </EditForm>

</div>
