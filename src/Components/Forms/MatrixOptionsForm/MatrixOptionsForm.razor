@rendermode InteractiveServer

<div class="mw-matrix-options-modal">
    <EditForm EditContext="_editContext" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />

    <div class="card">
        <div class="card-header">
            <h2>@(!string.IsNullOrEmpty(Title) ? Title : $"Matrix Options for {Action}")</h2>
            @if (OnGlobalOptionsForm)
            {
                <span>The checkbox at the start of each row controls whether the option shows on other pages (Import, Library etc)</span>
            }
        </div>
        <div class="card-body">
                @* Processing/result overlay is rendered as a full-window overlay below so it covers the entire form *@
               <div class="mw-matrix-form-fields">
    @if (ShowBrightness || OnGlobalOptionsForm)
    {
        <div class="mw-field-validation">
            <ValidationMessage For="@(() => Options.Brightness)" />
        </div>
        <div class="mw-matrix-form-row">
            @if (OnGlobalOptionsForm)
            {
                <InputCheckbox class="me-2" @bind-Value="BrightnessEnabledChecked" />
            }
            <label class="mw-matrix-label">Brightness %</label>
            <InputNumberOnInputNullable class="form-control mw-matrix-input" @bind-Value="Options.Brightness" @bind-Value:event="oninput" placeholder="@($"(Default: {_defaults.Brightness})")" />
        </div>
    }
    @if (!HideRelativeBrightness)
    {
        // Helper fields to show current relative and calculated brightness
        <div class="mw-matrix-form-row">
            <label class="mw-matrix-label">Relative Brightness %</label>
            <input type="number" class="form-control mw-matrix-input" value="@RelativeBrightness" disabled />
        </div>
        <div class="mw-matrix-form-row">
            <label class="mw-matrix-label">Actual Brightness %</label>
            <input type="number" class="form-control mw-matrix-input" value="@ActualBrightness" disabled />
        </div>
    }
    @if (ShowChainLength || OnGlobalOptionsForm)
    {
        <div class="mw-field-validation">
            <ValidationMessage For="@(() => Options.ChainLength)" />
        </div>
        <div class="mw-matrix-form-row">
            @if (OnGlobalOptionsForm)
            {
                <InputCheckbox class="me-2" @bind-Value="ChainLengthEnabledChecked" />
            }
            <label class="mw-matrix-label">Chain Length</label>
            <InputNumberOnInputNullable class="form-control mw-matrix-input" @bind-Value="Options.ChainLength" @bind-Value:event="oninput" placeholder="@($"(Default: {_defaults.ChainLength})")" />
        </div>
    }

    @if (ShowCols || OnGlobalOptionsForm)
    {
        <div class="mw-field-validation">
            <ValidationMessage For="@(() => Options.Cols)" />
        </div>
        <div class="mw-matrix-form-row">
            @if (OnGlobalOptionsForm)
            {
                <InputCheckbox class="me-2" @bind-Value="ColsEnabledChecked" />
            }
            <label class="mw-matrix-label">Cols</label>
            <InputNumberOnInputNullable class="form-control mw-matrix-input" @bind-Value="Options.Cols" @bind-Value:event="oninput" placeholder="@($"(Default: {_defaults.Cols})")" />
        </div>
    }

    @if (ShowDisableHardwarePulsing || OnGlobalOptionsForm)
    {
        <div class="mw-matrix-form-row">
            @if (OnGlobalOptionsForm)
            {
                <InputCheckbox class="me-2" @bind-Value="DisableHardwarePulsingEnabledChecked" />
            }
            <label class="mw-matrix-label">Disable Hardware Pulsing</label>
            <InputCheckbox class="form-check-input" @bind-Value="DisableHardwarePulsingChecked" />
        </div>
    }

    @if (ShowGpioSlowdown || OnGlobalOptionsForm)
    {
        <div class="mw-matrix-form-row">
            @if (OnGlobalOptionsForm)
            {
                <InputCheckbox class="me-2" @bind-Value="GpioSlowdownEnabledChecked" />
            }
            <label class="mw-matrix-label">Gpio Slowdown</label>
            <InputSelect class="form-control mw-matrix-input" TValue="string" @bind-Value="GpioSlowdownSelectValue">
                <option value="0">0</option>
                <option value="">(Default: 1)</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
            </InputSelect>
        </div>
    }

    @if (ShowHardwareMapping || OnGlobalOptionsForm)
    {
        <div class="mw-matrix-form-row">
            @if (OnGlobalOptionsForm)
            {
                <InputCheckbox class="me-2" @bind-Value="HardwareMappingEnabledChecked" />
            }
            <label class="mw-matrix-label">Hardware Mapping</label>
            <InputSelect class="form-control mw-matrix-input" TValue="string" @bind-Value="HardwareMappingSelectValue">
                <option value="">(Default: regular)</option>
                <option value="adafruit-hat">adafruit-hat</option>
                <option value="adafruit-hat-pwm">adafruit-hat-pwm</option>
                <option value="compute-module">compute-module</option>
            </InputSelect>
        </div>
    }

    @if (ShowInverseColors || OnGlobalOptionsForm)
    {
        <div class="mw-matrix-form-row">
            @if (OnGlobalOptionsForm)
            {
                <InputCheckbox class="me-2" @bind-Value="InverseColorsEnabledChecked" />
            }
            <label class="mw-matrix-label">Inverse Colors</label>
            <InputCheckbox class="form-check-input" @bind-Value="InverseColorsChecked" />
        </div>
    }

    @if (ShowLedRgbSequence || OnGlobalOptionsForm)
    {
        <div class="mw-matrix-form-row">
            @if (OnGlobalOptionsForm)
            {
                <InputCheckbox class="me-2" @bind-Value="LedRgbSequenceEnabledChecked" />
            }
            <label class="mw-matrix-label">Led RGB Sequence</label>
            <InputSelect class="form-control mw-matrix-input" TValue="string" @bind-Value="LedRgbSequenceSelectValue">
                <option value="">(Default: RGB)</option>
                <option value="RBG">RBG</option>
                <option value="GRB">GRB</option>
                <option value="GBR">GBR</option>
                <option value="BRG">BRG</option>
                <option value="BGR">BGR</option>
            </InputSelect>
        </div>
    }

    @if (ShowLimitRefreshRateHz || OnGlobalOptionsForm)
    {
        <div class="mw-field-validation">
            <ValidationMessage For="@(() => Options.LimitRefreshRateHz)" />
        </div>
        <div class="mw-matrix-form-row">
            @if (OnGlobalOptionsForm)
            {
                <InputCheckbox class="me-2" @bind-Value="LimitRefreshRateHzEnabledChecked" />
            }
            <label class="mw-matrix-label">Limit Refresh Rate Hz</label>
            <InputNumberOnInputNullable class="form-control mw-matrix-input" @bind-Value="Options.LimitRefreshRateHz" @bind-Value:event="oninput" placeholder="@($"(Default: {_defaults.LimitRefreshRateHz})")" />
        </div>
    }

    @if (ShowMultiplexing || OnGlobalOptionsForm)
    {
        <div class="mw-matrix-form-row">
            @if (OnGlobalOptionsForm)
            {
                <InputCheckbox class="me-2" @bind-Value="MultiplexingEnabledChecked" />
            }
            <label class="mw-matrix-label">Multiplexing</label>
            <InputSelect class="form-control mw-matrix-input" TValue="int" @bind-Value="MultiplexingSelectValue">
                <option value="0">(Default: Direct)</option>
                <option value="1">1 — Stripe</option>
                <option value="2">2 — Checkered</option>
                <option value="3">3 — Spiral</option>
                <option value="4">4 — ZStripe</option>
                <option value="5">5 — ZnMirrorZStripe</option>
                <option value="6">6 — coreman</option>
                <option value="7">7 — Kaler2Scan</option>
                <option value="8">8 — ZStripeUneven</option>
                <option value="9">9 — P10-128x4-Z</option>
                <option value="10">10 — QiangLiQ8</option>
                <option value="11">11 — InversedZStripe</option>
            </InputSelect>
        </div>
    }

    @if (ShowPanelType || OnGlobalOptionsForm)
    {
        <div class="mw-matrix-form-row">
            @if (OnGlobalOptionsForm)
            {
                <InputCheckbox class="me-2" @bind-Value="PanelTypeEnabledChecked" />
            }
            <label class="mw-matrix-label">Panel Type</label>
            <InputSelect class="form-control mw-matrix-input" TValue="string" @bind-Value="PanelTypeSelectValue">
                <option value="">(Default: HUB75)</option>
                <option value="FM6126A">FM6126A</option>
                <option value="FM6127">FM6127</option>
            </InputSelect>
        </div>
    }

    @if (ShowParallel || OnGlobalOptionsForm)
    {
        <div class="mw-field-validation">
            <ValidationMessage For="@(() => Options.Parallel)" />
        </div>
        <div class="mw-matrix-form-row">
            @if (OnGlobalOptionsForm)
            {
                <InputCheckbox class="me-2" @bind-Value="ParallelEnabledChecked" />
            }
            <label class="mw-matrix-label">Parallel</label>
            <InputNumberOnInputNullable class="form-control mw-matrix-input" @bind-Value="Options.Parallel" @bind-Value:event="oninput" placeholder="@($"(Default: {_defaults.Parallel})")" />
        </div>
    }

    @if (ShowPixelMapperConfig || OnGlobalOptionsForm)
    {
        <div class="mw-matrix-form-row">
            @if (OnGlobalOptionsForm)
            {
                <InputCheckbox class="me-2" @bind-Value="PixelMapperConfigEnabledChecked" />
            }
            <label class="mw-matrix-label">Pixel Mapper Config</label>
            <InputTextOnInput class="form-control mw-matrix-input" @bind-Value="Options.PixelMapperConfig" @bind-Value:event="oninput" placeholder="@($"(Default: {_defaults.PixelMapperConfig})")" />
        </div>
    }

    @if (ShowPwmBits || OnGlobalOptionsForm)
    {
        <div class="mw-matrix-form-row">
            @if (OnGlobalOptionsForm)
            {
                <InputCheckbox class="me-2" @bind-Value="PwmBitsEnabledChecked" />
            }
            <label class="mw-matrix-label">PWM Bits</label>
            <InputNumberOnInputNullable class="form-control mw-matrix-input" @bind-Value="Options.PwmBits" @bind-Value:event="oninput" placeholder="@($"(Default: {_defaults.PwmBits})")" />
        </div>
    }

    @if (ShowPwmDitherBits || OnGlobalOptionsForm)
    {
        <div class="mw-matrix-form-row">
            @if (OnGlobalOptionsForm)
            {
                <InputCheckbox class="me-2" @bind-Value="PwmDitherBitsEnabledChecked" />
            }
            <label class="mw-matrix-label">PWM Dither Bits</label>
            <InputSelect class="form-control mw-matrix-input" TValue="int" @bind-Value="PwmDitherBitsSelectValue">
                <option value="0">(Default: 0)</option>
                <option value="1">1</option>
                <option value="2">2</option>
            </InputSelect>
        </div>
    }

    @if (ShowPwmLsbNanoseconds || OnGlobalOptionsForm)
    {
        <div class="mw-field-validation">
            <ValidationMessage For="@(() => Options.PwmLsbNanoseconds)" />
        </div>
        <div class="mw-matrix-form-row">
            @if (OnGlobalOptionsForm)
            {
                <InputCheckbox class="me-2" @bind-Value="PwmLsbNanosecondsEnabledChecked" />
            }
            <label class="mw-matrix-label">PWM LSB Nanoseconds</label>
            <InputNumberOnInputNullable class="form-control mw-matrix-input" @bind-Value="Options.PwmLsbNanoseconds" @bind-Value:event="oninput" placeholder="@($"(Default: {_defaults.PwmLsbNanoseconds})")" />
        </div>
    }

    @if (ShowRowAddressType || OnGlobalOptionsForm)
    {
        <div class="mw-matrix-form-row">
            @if (OnGlobalOptionsForm)
            {
                <InputCheckbox class="me-2" @bind-Value="RowAddressTypeEnabledChecked" />
            }
            <label class="mw-matrix-label">Row Address Type</label>
            <InputSelect class="form-control mw-matrix-input" TValue="int" @bind-Value="RowAddressTypeSelectValue">
                <option value="0">(Default: 0)</option>
                <option value="1">1 — AB</option>
                <option value="2">2 — Direct row select</option>
                <option value="3">3 — ABC</option>
                <option value="4">4 — ABC Shift + DE direct</option>
                <option value="5">5 — ABC Alternate</option>
            </InputSelect>
        </div>
    }

    @if (ShowRows || OnGlobalOptionsForm)
    {
        <div class="mw-field-validation">
            <ValidationMessage For="@(() => Options.Rows)" />
        </div>
        <div class="mw-matrix-form-row">
            @if (OnGlobalOptionsForm)
            {
                <InputCheckbox class="me-2" @bind-Value="RowsEnabledChecked" />
            }
            <label class="mw-matrix-label">Rows</label>
            <InputNumberOnInputNullable class="form-control mw-matrix-input" @bind-Value="Options.Rows" @bind-Value:event="oninput" placeholder="@($"(Default: {_defaults.Rows})")" />
        </div>
    }

    @if (ShowScanMode || OnGlobalOptionsForm)
    {
        <div class="mw-matrix-form-row">
            @if (OnGlobalOptionsForm)
            {
                <InputCheckbox class="me-2" @bind-Value="ScanModeEnabledChecked" />
            }
            <label class="mw-matrix-label">Scan Mode</label>
            <InputSelect class="form-control mw-matrix-input" TValue="int" @bind-Value="ScanModeSelectValue">
                <option value="0">(Default: Progressive)</option>
                <option value="1">1 — Interlaced</option>
            </InputSelect>
        </div>
    }

    @* led-image-viewer args preview *@
    </div>
        </div>

        <div class="card-footer text-end">
            <div class="mw-args-preview-inline mb-2">
                <label class="mw-matrix-label mw-args-inline-label">CLI Arguments Preview</label>
                <textarea class="form-control mw-args-preview-textarea" rows="2" readonly>@ArgsPreview</textarea>
            </div>
            <button type="button" class="btn btn-secondary me-2" @onclick="HandleOk">Cancel</button>
            <button type="submit" class="btn btn-primary" disabled="@_hasValidationErrors">@Action</button>
        </div>
    </div>

    </EditForm>

</div>
