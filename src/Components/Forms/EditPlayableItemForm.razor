@inject IJSRuntime JS
@inject WearWare.Services.MatrixConfig.MatrixConfigService MatrixConfigService
@inject ILogger<EditPlayableItemForm> _logger
@using WearWare.Common
@using WearWare.Common.Media
@using WearWare.Services.MatrixConfig
@using WearWare.Utils
@using System.ComponentModel.DataAnnotations

@code {
    private readonly string _logTag = "EditPlayableItemForm";
    /// <summary>
    /// The PlayableItem being edited.
    /// In ADD mode, this will be a Library item clone.
    /// In EDIT mode, this will be the Playlist or QuickMedia item being edited.
    /// </summary>
    [Parameter] public PlayableItem? EditingItem { get; set; }
    /// <summary>
    /// The index of the item being edited in the Playlist or QuickMedia list.
    /// In ADD mode, this will be the index where the new item will be inserted.
    /// In EDIT mode, this will be the index of the item being edited.
    /// </summary>

    [Parameter] public int EditingIndex { get; set; }

    /// <summary>
    /// The URL of the image to display for the item being edited
    /// In ADD mode, this will be the Library image URL.
    /// In EDIT mode, this will be the Playlist or QuickMedia image URL depending on where the item is from.
    /// </summary>
    [Parameter] public string? ImageUrl { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    /// <summary>
    /// Callback for clicking OK in regular Add / Edit mode
    /// </summary>
    [Parameter] public EventCallback<(int editingIndex, PlayableItem updatedItem, PlayableItemFormMode formMode)> OnSave { get; set; }
    /// <summary>
    /// Callback for clicking OK in ReConvert All mode
    /// </summary>
    [Parameter] public EventCallback<(PlayableItemFormMode formMode, int relativeBrightness, LedMatrixOptionsConfig? options)> OnReconvertAllOk { get; set; }

    // ToDo: Remove this and do convert on save instead of immediate convert on ReConvert
    // Needs to be left until QuickMedia page is updated to not use it
    [Parameter] public Func<LedMatrixOptionsConfig, int, Task<WearWare.Common.ReConvertTaskResult>>? OnReprocessAsync { get; set; }
    [Parameter] public PlayableItemType ItemType { get; set; } = PlayableItemType.UNKNOWN;
    [Parameter] public PlayableItemFormMode FormMode { get; set; } = PlayableItemFormMode.Edit;

    private Dictionary<string, int> playModeOptions = new()
    {
        { "Loop", (int)PlayMode.LOOP },
        { "Duration", (int)PlayMode.DURATION },
        { "Forever", (int)PlayMode.FOREVER }
    };

    // === Form edited values ===
    // The currently selected play mode in the form
    private int selectedPlayMode;
    // The currently selected play mode value in the form
    private int selectedPlayModeValue;
    // The currently selected relative brightness in the form
    private int selectedRelativeBrightness;

    private LedMatrixOptionsConfig? selectedMatrixOptions;
    private string nameInput = string.Empty;
    private ImportNameModel importNameModel = new();

    public class ImportNameModel
    {
        [Required]
        [RegularExpression($"^[{FilenameValidator.AllowedPattern}]+$", ErrorMessage = "Name must only contain letters, numbers, dashes, or underscores.")]
        public string Name { get; set; } = string.Empty;
    }

    // === Form readouts ===
    // Holds the current brightness that the stream was last converted with
    private int streamCurrentBrightness;

    // What the brightness WOULD BE if we reprocessed now with current matrix options and selected relative brightness
    private int adjustedBrightness;

    // === Misc ===
    // True when the Matrix Options form is visible
    private bool showMatrixOptionsForm = false;

    protected override void OnInitialized()
    {
        if (EditingItem == null)
        {
            // If we're being used for ReConvertAll flows, EditingItem may be null.
            // Initialize reasonable defaults so the dialog can render and be used
            // to select relative brightness and matrix options.
            if (FormMode == PlayableItemFormMode.ReConvertAllMatrix || FormMode == PlayableItemFormMode.ReConvertAllBrightness)
            {
                selectedPlayMode = (int)PlayMode.LOOP;
                selectedPlayModeValue = 1;
                selectedRelativeBrightness = 100;
                selectedMatrixOptions = MatrixConfigService.CloneOptions();
                nameInput = string.Empty;
                importNameModel.Name = string.Empty;
                streamCurrentBrightness = selectedMatrixOptions?.Brightness ?? 100;
                CalculateBrightness();
                return;
            }
            _logger.LogError($"{_logTag}: EditingItem is null in EditPlayableItemForm");
            return;
        }
        selectedPlayMode = (int)EditingItem.PlayMode;
        selectedPlayModeValue = EditingItem.PlayModeValue;
        selectedRelativeBrightness = EditingItem.RelativeBrightness;
        selectedMatrixOptions = EditingItem.MatrixOptions.Clone();
        nameInput = EditingItem.Name;
        importNameModel.Name = nameInput;
        streamCurrentBrightness = EditingItem.CurrentBrightness;
        CalculateBrightness();
    }

    /// <summary>
    /// Called after the component has been rendered.
    /// Note: IDE says 0 references, but it is called by Blazor framework.
    /// </summary>
    /// <param name="firstRender">True if this is the first time the component is rendered</param>
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("import", "/js/ScrollbarHider.js");
            await JS.InvokeVoidAsync("modalScrollLock.lock");
        }
    }

    /// <summary>
    /// Unlocks scroll when the form is disposed 
    /// </summary>
    public async Task UnlockScrollAsync()
    {
        await JS.InvokeVoidAsync("modalScrollLock.unlock");
    }

    public async ValueTask DisposeAsync()
    {
        await JS.InvokeVoidAsync("modalScrollLock.unlock");
    }

    /// <summary>
    /// Called when the user changes the Play Mode radio buttons
    /// </summary>
    private void OnSelectPlayMode(int value)
    {
        selectedPlayMode = value;
        if (selectedPlayMode == (int)PlayMode.FOREVER)
        {
            selectedPlayModeValue = 1;
        }
    }

    /// <summary>
    /// Called when the user changes the Play Mode Value input
    /// </summary>
    private void OnSelectPlayModeValue(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var v))
            selectedPlayModeValue = v;
    }

    /// <summary>
    /// Setter is called when the Relative Brightness input is changed
    /// </summary>
    public int SelectedRelativeBrightness
    {
        get => selectedRelativeBrightness;
        set
        {
            if (selectedRelativeBrightness != value)
            {
                selectedRelativeBrightness = value;
                CalculateBrightness();
                InvokeAsync(StateHasChanged);
            }
        }
    }

    // Recalculates adjusted brightness based on current matrix options and selected relative brightness
    private void CalculateBrightness(){
        int baseBrightness;
        if (selectedMatrixOptions == null){
            _logger.LogWarning($"{_logTag}: selectedMatrixOptions is null in EditPlayableItemForm; using default brightness of 100");
            baseBrightness = 100;
        }
        else
        {
            baseBrightness = selectedMatrixOptions.Brightness ?? 100;
        }
        adjustedBrightness = BrightnessCalculator.CalculateAbsoluteBrightness(baseBrightness, selectedRelativeBrightness);
    }

    /// <summary>
    /// Called after the user clicks OK in the Matrix Options form
    /// </summary>
    /// <param name="opts">The updated matrix options</param>
    private async Task OnMatrixOptionsOk(LedMatrixOptionsConfig opts)
    {
        selectedMatrixOptions = opts;
        showMatrixOptionsForm = false;
        CalculateBrightness();
        await InvokeAsync(StateHasChanged);
    }

    /// <summary>
    /// Called after the user clicks Cancel in the Matrix Options form
    /// </summary>
    private Task OnMatrixOptionsCancel()
    {
        showMatrixOptionsForm = false;
        InvokeAsync(StateHasChanged);
        return Task.CompletedTask;
    }

    /// <summary>
    /// Called when user clicks Save button
    /// </summary>
    private void SaveEdit()
    {
        // If we're in a ReConvertAll mode, call the dedicated callback instead
        if (FormMode == PlayableItemFormMode.ReConvertAllMatrix || FormMode == PlayableItemFormMode.ReConvertAllBrightness)
        {
            OnReconvertAllOk.InvokeAsync((FormMode, selectedRelativeBrightness, selectedMatrixOptions));
            return;
        }

        if (EditingItem == null){
            _logger.LogError($"{_logTag}: Cannot save PlayableItem; EditingItem is null");
            return;
        }
        if (selectedMatrixOptions == null){
            _logger.LogError($"{_logTag}: Cannot save PlayableItem; selectedMatrixOptions is null");
            return;
        }
        // Copy mutable properties into the item to send back. For Import flows, Name is init-only,
        // so construct a new PlayableItem with the edited name.
        if (ItemType == PlayableItemType.Import)
        {
            // Validate name via importNameModel; sanitize before creating PlayableItem
            var sanitized = FilenameValidator.Sanitize(importNameModel.Name ?? string.Empty);
            var updated = new PlayableItem(
                sanitized,
                EditingItem.ParentFolder,
                EditingItem.MediaType,
                EditingItem.SourceFileName,
                (PlayMode)selectedPlayMode,
                selectedPlayModeValue,
                Math.Clamp(selectedRelativeBrightness, 1, 100),
                adjustedBrightness,
                selectedMatrixOptions.Clone()
            );
            OnSave.InvokeAsync((EditingIndex, updated, FormMode));
            return;
        }

        EditingItem.PlayMode = (PlayMode)selectedPlayMode;
        EditingItem.PlayModeValue = selectedPlayModeValue;
        EditingItem.RelativeBrightness = Math.Clamp(selectedRelativeBrightness, 1, 100);
        EditingItem.CurrentBrightness = adjustedBrightness;
        EditingItem.MatrixOptions = selectedMatrixOptions;
        OnSave.InvokeAsync((EditingIndex, EditingItem, FormMode));
    }

    /// <summary>
    /// Called when user clicks Matrix Options button
    /// </summary>
    private void ShowMatrixOptions()
    {
        showMatrixOptionsForm = true;
    }

    /// <summary>
    /// Builds the title for the form based on mode and item type
    /// </summary>
    /// <returns>The page title</returns>
    private string BuildPageTitle(){
        if (FormMode == PlayableItemFormMode.ReConvertAllMatrix)
        {
            return $"ReConvert {ItemType} (Matrix Options)";
        }
        else if (FormMode == PlayableItemFormMode.ReConvertAllBrightness)
        {
            return $"ReConvert {ItemType} (Brightness)";
        }
        var title = ItemType == PlayableItemType.Import ? "" : $"{FormMode.ToString()} ";
        title += ItemType.ToString();
        if (ItemType == PlayableItemType.QuickMedia){
            title += $" B{EditingIndex + 1}";
        }
        else
        {
            title += " Item";
        }
        return title;
    }

    /// <summary>
    /// Builds the title for the Matrix Options form based on item type
    /// </summary>
    /// <returns>The title for the matrix options form</returns>
    private string BuildMatrixOptionsTitle(){
        return ItemType switch
        {
            PlayableItemType.Library => "Library Item Matrix Options",
            PlayableItemType.Playlist => "Playlist Item Matrix Options",
            PlayableItemType.QuickMedia => $"Button {EditingIndex + 1} Matrix Options",
            _ => "Matrix Options"
        };
    }
}

@* Main Razor Markup: *@
@if (EditingItem is not null || FormMode == PlayableItemFormMode.ReConvertAllMatrix || FormMode == PlayableItemFormMode.ReConvertAllBrightness)
{
    <div class="edit-dialog" @onclick="() => OnCancel.InvokeAsync(null)">
        <div class="edit-dialog__content" @onclick:stopPropagation>
            <h4>@BuildPageTitle()</h4>
            @if(FormMode == PlayableItemFormMode.ReConvertAllMatrix)
            {
                <div style ="margin-bottom:1rem;">
                    <span>ReConverts all @ItemType items with their Relative Brightness and the selected Matrix Options (Defaults to the Global Matrix options)</span>
                </div>
            }
            else if(FormMode == PlayableItemFormMode.ReConvertAllBrightness)
            {
                <div style ="margin-bottom:1rem;">
                    <span>ReConverts all @ItemType items with a new Relative Brightness and their embedded Matrix Options</span>
                </div>
            }
            @if (ItemType == PlayableItemType.Import)
            {
                <div class="add-dialog-row" style="margin-top:0.5rem; margin-bottom:1rem;">
                    <EditForm Model="importNameModel">
                        <DataAnnotationsValidator />
                        <label class="add-dialog-label">Name
                            <InputText class="add-dialog-number" style="width: 20rem; border-radius: 6px;" @bind-Value="importNameModel.Name" />
                        </label>
                        <ValidationMessage For="@(() => importNameModel.Name)" />
                    </EditForm>
                </div>
            }
            @if (ItemType != PlayableItemType.Library && ItemType != PlayableItemType.Import && 
                FormMode != PlayableItemFormMode.ReConvertAllMatrix && FormMode != PlayableItemFormMode.ReConvertAllBrightness)
            {
                <div class="add-dialog-row">
                    <div class="add-dialog-section">
                        <div class="add-dialog-options">
                            @foreach (var mode in playModeOptions)
                            {
                                <label class="add-dialog-radio-label">
                                    <span class="add-dialog-mode-text">@mode.Key</span>
                                    <input type="radio" name="editPlayMode" value="@mode.Value" @onchange="() => OnSelectPlayMode(mode.Value)" checked="@(selectedPlayMode == mode.Value)" class="add-dialog-radio" />
                                </label>
                            }
                        </div>
                    </div>
                    <div class="add-dialog-section">
                        <label class="add-dialog-label">Value</label>
                        <input type="number" class="add-dialog-number" value="@selectedPlayModeValue" min="1" max="100" disabled="@(selectedPlayMode == (int)PlayMode.FOREVER)" @onchange="OnSelectPlayModeValue" />
                    </div>
                </div>
            }
            @if (FormMode != PlayableItemFormMode.ReConvertAllMatrix && FormMode != PlayableItemFormMode.ReConvertAllBrightness){
                <div class="add-dialog__list">
                    <div style="display:flex; align-items:center; gap:1rem;">
                        <img class="add-dialog__item-image" src="@ImageUrl" alt="@EditingItem?.Name" />
                        <div>
                            <strong>@EditingItem?.Name</strong><br />
                            <span class="add-dialog__item-type">@EditingItem?.MediaType</span>
                        </div>
                    </div>
                </div>
                <div class="add-dialog-row" style="margin-top: 1em;">
                    <label class="add-dialog-label">Stream Current Brightness (%)
                        <input type="number" disabled class="add-dialog-number" @bind="streamCurrentBrightness"/>
                    </label>
                </div>
            }
            @if (FormMode != PlayableItemFormMode.ReConvertAllMatrix){
                <div class="add-dialog-row">
                    <label class="add-dialog-label">Relative Brightness (%)
                        <input type="number" class="add-dialog-number" @bind="SelectedRelativeBrightness" @bind:event="oninput" min="1" max="100" />
                    </label>
                </div>
            }
            @if (FormMode != PlayableItemFormMode.ReConvertAllMatrix && FormMode != PlayableItemFormMode.ReConvertAllBrightness){
                <div class="add-dialog-row">
                    <label class="add-dialog-label">Adjusted Brightness (%)
                        <input type="number" disabled class="add-dialog-number" @bind="adjustedBrightness" @bind:event="oninput" min="1" max="100" />
                    </label>
                </div>
            }
            @if (FormMode != PlayableItemFormMode.ReConvertAllBrightness)
            {
                <button type="button" class="add-dialog__cancel-button" @onclick="ShowMatrixOptions">Matrix Options</button>
            }
            <div style="margin-top:0.75rem; display:flex; gap:0.5rem; justify-content:center; width:100%; flex-direction:column; align-items:center;">
                <div style="display:flex; gap:0.5rem;">
                    <button type="button" class="add-dialog__cancel-button" @onclick="() => OnCancel.InvokeAsync(null)">Cancel</button>
                    <button type="button" class="add-dialog__cancel-button" @onclick="SaveEdit">OK</button>
                </div>
            </div>
        </div>
    </div>
}

@* Matrix Options form *@
@if (showMatrixOptionsForm && selectedMatrixOptions is not null)
{
    <div style="position:fixed; z-index:9999; inset:8% 10%; display:flex; align-items:flex-start; justify-content:center;">
            <div style="width:80%;">
            <WearWare.Components.Forms.MatrixOptionsForm Options="selectedMatrixOptions.Clone()"
                Visibility="MatrixConfigService.Visibility"
                RelativeBrightness="selectedRelativeBrightness"
                OnValidSubmit="OnMatrixOptionsOk"
                OnCancel="OnMatrixOptionsCancel"
                Action="OK"
                Title="@BuildMatrixOptionsTitle()" />
        </div>
    </div>
}
