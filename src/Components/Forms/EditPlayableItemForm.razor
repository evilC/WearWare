@inject IJSRuntime JS
@inject WearWare.Services.MatrixConfig.MatrixConfigService MatrixConfigService
@inject ILogger<EditPlayableItemForm> _logger
@using WearWare.Common
@using WearWare.Common.Media
@using WearWare.Services.MatrixConfig

@code {
    private readonly string _logTag = "EditPlayableItemForm";
    [Parameter] public PlayableItem? EditingItem { get; set; }
    [Parameter] public int EditingIndex { get; set; }
    [Parameter] public string? ImageUrl { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public EventCallback<(int editingIndex, PlayableItem updatedItem)> OnSave { get; set; }
    [Parameter] public Func<LedMatrixOptionsConfig, int, Task<WearWare.Common.ReConvertTaskResult>>? OnReprocessAsync { get; set; }
    [Parameter] public string PageTitle { get; set; } = "Playlist";

    private Dictionary<string, int> playModeOptions = new()
    {
        { "Loop", (int)PlayMode.LOOP },
        { "Duration", (int)PlayMode.DURATION },
        { "Forever", (int)PlayMode.FOREVER }
    };

    private int selectedPlayMode;
    private int selectedPlayModeValue;
    // The currently selected relative brightness in the form
    private int selectedRelativeBrightness;
    // True if relative brightness has been modified since load/save...
    // ... and we have not reprocessed yet
    private bool saveDisabled = false;
    // Holds the adjusted brightness based on current matrix options and selected relative brightness
    // Also, if we used ReConvert, this is updated to reflect the actual brightness used
    private int adjustedBrightness;
    // Holds the current brightness that the stream was last converted with
    // If the user has reconverted with different brightness, this will differ from EditingItem.CurrentBrightness
    // In which case, disable the Cancel button to prevent loss of current brightness change
    private int streamCurrentBrightness;
    // True if the stream's brightness has been changed since load/save
    // Either changing relative brightness or reprocessing may change actual brightness
    // If true, then Cancel is disabled to prevent loss of actual brightness change
    private bool cancelDisabled = false;

    private bool showOptionsForm = false;
    private LedMatrixOptionsConfig? modalOptions;
    private WearWare.Common.ReConvertTaskResult? lastReprocessResult;

    protected override void OnInitialized()
    {
        if (EditingItem != null)
        {
            selectedPlayMode = (int)EditingItem.PlayMode;
            selectedPlayModeValue = EditingItem.PlayModeValue;
            selectedRelativeBrightness = EditingItem.RelativeBrightness;
            streamCurrentBrightness = EditingItem.CurrentBrightness;
            adjustedBrightness = BrightnessCalculator.CalculateAbsoluteBrightness(MatrixConfigService.CloneOptions().Brightness ?? 100, selectedRelativeBrightness);
            saveDisabled = false;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("import", "/js/ScrollbarHider.js");
            await JS.InvokeVoidAsync("modalScrollLock.lock");
        }
    }

    public async Task UnlockScrollAsync()
    {
        await JS.InvokeVoidAsync("modalScrollLock.unlock");
    }

    public async ValueTask DisposeAsync()
    {
        await JS.InvokeVoidAsync("modalScrollLock.unlock");
    }

    private void OnSelectPlayMode(int value)
    {
        selectedPlayMode = value;
        if (selectedPlayMode == (int)PlayMode.FOREVER)
        {
            selectedPlayModeValue = 1;
        }
    }

    private void OnSelectPlayModeValue(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var v))
            selectedPlayModeValue = v;
    }

    // Setter is called when the Relative Brightness input is changed
    public int SelectedRelativeBrightness
    {
        get => selectedRelativeBrightness;
        set
        {
            if (selectedRelativeBrightness != value)
            {
                selectedRelativeBrightness = value;
                // Recalculate actual brightness using current matrix options
                var baseBrightness = MatrixConfigService.CloneOptions().Brightness ?? 100;
                adjustedBrightness = BrightnessCalculator.CalculateAbsoluteBrightness(baseBrightness, selectedRelativeBrightness);
                SetSaveCancelButtonStates();
                InvokeAsync(StateHasChanged);
            }
        }
    }

    // Called once ReProcess has completed
    private async Task<WearWare.Common.ReConvertTaskResult> HandleReprocessAsync(LedMatrixOptionsConfig opts)
    {
        if (OnReprocessAsync != null)
        {
            var res = await OnReprocessAsync(opts, selectedRelativeBrightness);
            lastReprocessResult = res;
            if (res.ExitCode == 0)
            {
                streamCurrentBrightness = res.ActualBrightness;
                adjustedBrightness = res.ActualBrightness;
                SetSaveCancelButtonStates();
            }
            return res;
        }
        var noop = new WearWare.Common.ReConvertTaskResult { ExitCode = 0, Error = "", Message = "No reprocess handler provided.", ActualBrightness = (EditingItem?.CurrentBrightness ?? 0) };
        lastReprocessResult = noop;
        return noop;
    }

    private void SetSaveCancelButtonStates()
    {
        if (EditingItem == null)
        {
            cancelDisabled = false; // allow cancel to close the form
            saveDisabled = true;    // nothing to save
            return;
        }

        // Cancel is disabled if stream brightness has been modified since load/save...
        cancelDisabled = streamCurrentBrightness != EditingItem.CurrentBrightness;
        // Save is disabled if relative brightness has been modified since load/save, and we have not reprocessed yet...
        // ... ie streamCurrentBrightness is not equal to adjustedBrightness...
        // ... AND streamCurrentBrightness is not equal to actualBrightness (ie this is detecting if we have reprocessed yet)
        saveDisabled = ((selectedRelativeBrightness != EditingItem.CurrentBrightness)
            && (streamCurrentBrightness != adjustedBrightness));

        if (saveDisabled && cancelDisabled)
        {
            _logger.LogWarning($"{_logTag}: Both Save and Cancel buttons are disabled in Edit Playable Item form; this should not happen.");
            cancelDisabled = false; // allow cancel to close the form
        }
            

    }

    private void SaveEdit()
    {
        if (EditingItem != null)
        {
            EditingItem.PlayMode = (PlayMode)selectedPlayMode;
            EditingItem.PlayModeValue = selectedPlayModeValue;
            EditingItem.RelativeBrightness = Math.Clamp(selectedRelativeBrightness, 1, 100);
            EditingItem.CurrentBrightness = streamCurrentBrightness;
            OnSave.InvokeAsync((EditingIndex, EditingItem));
        }
    }

    private void ShowReprocess()
    {
        modalOptions = MatrixConfigService.CloneOptions();
        // clear any previous result and show the options form
        lastReprocessResult = null;
        showOptionsForm = true;
    }

    private Task OnOptionsOk()
    {
        // Close the options modal. The result (if any) is stored in `lastReprocessResult`.
        showOptionsForm = false;
        modalOptions = null;
        InvokeAsync(StateHasChanged);
        return Task.CompletedTask;
    }
}

@if (EditingItem is not null)
{
    <div class="edit-dialog" @onclick="() => OnCancel.InvokeAsync(null)">
        <div class="edit-dialog__content" @onclick:stopPropagation>
            <h2>Edit @PageTitle</h2>
            <div class="add-dialog-row">
                <div class="add-dialog-section">
                    <div class="add-dialog-options">
                        @foreach (var mode in playModeOptions)
                        {
                            <label class="add-dialog-radio-label">
                                <span class="add-dialog-mode-text">@mode.Key</span>
                                <input type="radio" name="editPlayMode" value="@mode.Value" @onchange="() => OnSelectPlayMode(mode.Value)" checked="@(selectedPlayMode == mode.Value)" class="add-dialog-radio" />
                            </label>
                        }
                    </div>
                </div>
                <div class="add-dialog-section">
                    <label class="add-dialog-label">Value</label>
                    <input type="number" class="add-dialog-number" value="@selectedPlayModeValue" min="1" max="100" disabled="@(selectedPlayMode == (int)PlayMode.FOREVER)" @onchange="OnSelectPlayModeValue" />
                </div>
            </div>
            <div class="add-dialog__list">
                <div style="display:flex; align-items:center; gap:1rem;">
                    <img class="add-dialog__item-image" src="@ImageUrl" alt="@EditingItem?.Name" />
                    <div>
                        <strong>@EditingItem?.Name</strong><br />
                        <span class="add-dialog__item-type">@EditingItem?.MediaType</span>
                    </div>
                </div>
            </div>
            <div class="add-dialog-row" style="margin-top:1rem;">
                <label class="add-dialog-label">Stream Current Brightness (%)
                    <input type="number" disabled class="add-dialog-number" @bind="streamCurrentBrightness"/>
                </label>
            </div>
            <div class="add-dialog-row" style="margin-top:1rem;">
                <label class="add-dialog-label">Relative Brightness (%)
                    <input type="number" class="add-dialog-number" @bind="SelectedRelativeBrightness" @bind:event="oninput" min="1" max="100" />
                </label>
            </div>
            <div class="add-dialog-row" style="margin-top:1rem;">
                <label class="add-dialog-label">Adjusted Brightness (%)
                    <input type="number" disabled class="add-dialog-number" @bind="adjustedBrightness" @bind:event="oninput" min="1" max="100" />
                </label>
            </div>
            <div style="margin-top:0.75rem; display:flex; gap:0.5rem; justify-content:center; width:100%; flex-direction:column; align-items:center;">
                <div style="display:flex; gap:0.5rem;">
                    <button type="button" class="add-dialog__cancel-button" @onclick="() => OnCancel.InvokeAsync(null)" disabled="@cancelDisabled">Cancel</button>
                    <button type="button" class="add-dialog__cancel-button" @onclick="SaveEdit" disabled="@saveDisabled">Save</button>
                    <button type="button" class="add-dialog__cancel-button" @onclick="ShowReprocess">ReConvert</button>
                </div>
            </div>
        </div>
    </div>
}

@if (showOptionsForm && modalOptions is not null)
{
    <div style="position:fixed; z-index:9999; inset:8% 10%; display:flex; align-items:flex-start; justify-content:center;">
            <div style="width:80%;">
            <WearWare.Components.Forms.MatrixOptionsForm Options="modalOptions" Visibility="MatrixConfigService.Visibility" RelativeBrightness="selectedRelativeBrightness" OnValidSubmitAsync="HandleReprocessAsync" OnCancel="OnOptionsOk" Action="ReConvert" Title="Matrix Options for ReConvert" />
        </div>
    </div>
}
