@using System.Text.RegularExpressions
@using WearWare.Services
@using Microsoft.AspNetCore.Components
@using System.Threading.Tasks
@using System.ComponentModel.DataAnnotations
@using WearWare.Services.Import
@using WearWare.Common.Media
@using WearWare.Utils


<EditForm Model="model" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <InputText @bind-Value="model.Name" placeholder="Enter name" />
    <ValidationMessage For="@(() => model.Name)" />
    <button type="submit">Continue</button>
    <button type="button" @onclick="OnCancelClicked">Cancel</button>
</EditForm>

@code {

    public class ImportLibraryItemModel
    {
        [Required]
    #if NET6_0_OR_GREATER
    #else
    #endif
           [RegularExpression($"^[{FilenameValidator.AllowedPattern}]+$", ErrorMessage = "Name must only contain letters, numbers, dashes, or underscores.")]
        public string Name { get; set; } = string.Empty;
    }

    [Parameter] public string FileName { get; set; } = string.Empty;
    [Parameter] public EventCallback<string> OnFilenameConfirmed { get; set; }
    // No longer inject ImportService
    
    private ImportLibraryItemModel model = new();
    // No longer track importing or import result

    protected override void OnInitialized()
    {
        // Remove extension and replace invalid chars with dashes
        var baseName = Path.GetFileNameWithoutExtension(FileName);
        model.Name = FilenameValidator.Sanitize(baseName);
    }

    private async Task HandleValidSubmit()
    {
        // Sanitize and confirm filename to parent
        var sanitized = FilenameValidator.Sanitize(model.Name);
        if (OnFilenameConfirmed.HasDelegate)
            await OnFilenameConfirmed.InvokeAsync(sanitized);
    }

    // No longer need OnOkClicked

    private async Task OnCancelClicked()
    {
        if (OnFilenameConfirmed.HasDelegate)
            await OnFilenameConfirmed.InvokeAsync(null);
    }
}
