@using System.Text.RegularExpressions
@using WearWare.Services
@using Microsoft.AspNetCore.Components
@using System.Threading.Tasks
@using System.ComponentModel.DataAnnotations
@using WearWare.Services.Import
@using WearWare.Common.Media
@using WearWare.Utils


<EditForm Model="model" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />
    <div class="mw-matrix-form-row">
        <label class="mw-matrix-label">Name
            <InputText class="mw-matrix-input" @bind-Value="model.Name" placeholder="Enter name" />
            <ValidationMessage For="@(() => model.Name)" />
        </label>
    </div>
    <div class="mw-matrix-form-row">
    </div>
    <button type="submit">Continue</button>
    <button type="button" @onclick="OnCancelClicked">Cancel</button>
</EditForm>

@code {

    public class ImportLibraryItemModel
    {
        [Required]
    #if NET6_0_OR_GREATER
    #else
    #endif
        [RegularExpression($"^[{FilenameValidator.AllowedPattern}]+$", ErrorMessage = "Name must only contain letters, numbers, dashes, or underscores.")]
        public string Name { get; set; } = string.Empty;
        [Range(1, 100, ErrorMessage = "Relative Brightness must be between 1 and 100.")]
        public int RelativeBrightness { get; set; } = 100;
    }

    [Parameter] public string FileName { get; set; } = string.Empty;
    [Parameter] public EventCallback<(string? newFileName, int relativeBrightness)> OnFilenameConfirmed { get; set; }
    // No longer inject ImportService
    
    private ImportLibraryItemModel model = new();
    // No longer track importing or import result

    protected override void OnInitialized()
    {
        // Remove extension and replace invalid chars with dashes
        var baseName = Path.GetFileNameWithoutExtension(FileName);
        model.Name = FilenameValidator.Sanitize(baseName);
    }

    private async Task HandleValidSubmit()
    {
        // Sanitize and confirm filename to parent
        var sanitized = FilenameValidator.Sanitize(model.Name);
        if (OnFilenameConfirmed.HasDelegate)
            await OnFilenameConfirmed.InvokeAsync((sanitized, model.RelativeBrightness));
    }

    // No longer need OnOkClicked

    private async Task OnCancelClicked()
    {
        if (OnFilenameConfirmed.HasDelegate)
            await OnFilenameConfirmed.InvokeAsync((null, model.RelativeBrightness));
    }
}
