@page "/library"
@using WearWare.Common.Media
@using WearWare.Components.Forms.EditPlayableItemForm
@rendermode InteractiveServer

<PageTitle>WareWare - Library</PageTitle>

<span style="display:block; margin-bottom:1em;">Click on an image to play a preview as a QuickMedia item in FOREVER mode. Click the item again to stop the preview.</span>
@if (items == null)
{
    <p>Loading...</p>
}
else if (!items.Any())
{
    <p>No items found in the library.</p>
}
else
{
    <button class="reconvert-all-button btn-outline-primary" @onclick="() => ShowReConvertAllGlobal()">ReConvert all with new Matrix Options</button>
    <button class="reconvert-all-button btn-outline-primary" @onclick="() => ShowReConvertAllEmbedded()">ReConvert all with new Brightness</button>
    <ul class="library-list" style="list-style:none; padding:0; margin:0;">
        @foreach (var item in items)
        {
            <li style="margin-bottom:2em; display:flex; align-items:center; gap:0.5rem; cursor:pointer;" @onclick="() => LibraryService.PlayPreviewItem(item)">
                <div style="display:flex; flex-direction:column; gap:0.25em;">
                    <button type="button" class="btn btn-sm btn-outline-primary" @onclick:stopPropagation @onclick="() => ShowReconvert(item)">Edit</button>
                    <button type="button" class="btn btn-sm btn-outline-danger" @onclick:stopPropagation @onclick="() => ConfirmDelete(item)">Delete</button>
                </div>
                <img src="/library-image/@item.SourceFileName" alt="@item.Name" style="max-width:64px; max-height:64px; border-radius:8px; box-shadow:0 1px 8px #0002; background:#eee;" />
                <div>
                    <strong style="font-size:1em; color:#222;">@item.Name</strong><br />
                    <span>Brightness: @item.CurrentBrightness%</span>
                </div>
            </li>
        }
    </ul>
}

@if (_editFormModel != null && _editFormModel.FormMode != EditPlayableItemFormMode.ReConvertAllMatrix && _editFormModel.FormMode != EditPlayableItemFormMode.ReConvertAllBrightness)
{
    <div style="position:fixed; z-index:9999; inset:8% 10%; display:flex; align-items:flex-start; justify-content:center;">
        <div style="width:80%;">
            <EditPlayableItemForm @ref="_editFormRef"
                FormModel="_editFormModel"
                OnNewSave="OnSaveLibraryItem"
                OnCancel="OnEditFormCancel"
            />
        </div>
    </div>
}

@if (_editFormModel is not null && (_editFormModel.FormMode == EditPlayableItemFormMode.ReConvertAllMatrix || _editFormModel.FormMode == EditPlayableItemFormMode.ReConvertAllBrightness))
{
    <div style="position:fixed; z-index:9999; inset:8% 10%; display:flex; align-items:flex-start; justify-content:center;">
        <div style="width:80%;">
            <EditPlayableItemForm @ref="_editFormRef"
                FormModel="_editFormModel"
                OnReconvertAllOk="OnReconvertAll"
                OnCancel="OnEditFormCancel"
            />
        </div>
    </div>
}
