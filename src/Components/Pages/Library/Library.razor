@page "/library"
@using WearWare.Common
@using WearWare.Services.Library
@using WearWare.Services.MatrixConfig
@using WearWare.Services.StreamConverter
@using WearWare.Config
@using WearWare.Common.Media
@inject WearWare.Services.Library.LibraryService LibraryService
@inject WearWare.Services.MatrixConfig.MatrixConfigService MatrixConfigService
@inject WearWare.Services.StreamConverter.IStreamConverterService StreamConverterService
@rendermode InteractiveServer
@inject IJSRuntime JSRuntime

<PageTitle>Library</PageTitle>

<h3>Library Items</h3>
<span style="display:block; margin-bottom:1em;">Click on an image to play a preview as a QuickMedia item in FOREVER mode. Click the item again to stop the preview.</span>
@if (items == null)
{
    <p>Loading...</p>
}
else if (!items.Any())
{
    <p>No items found in the library.</p>
}
else
{
    <ul class="library-list" style="list-style:none; padding:0; margin:0;">
        @foreach (var item in items)
        {
            <li style="margin-bottom:2em; display:flex; align-items:center; gap:0.5rem; cursor:pointer;" @onclick="() => LibraryService.PlayPreviewItem(item)">
                <div style="display:flex; flex-direction:column; gap:0.25em;">
                    <button type="button" class="btn btn-sm btn-outline-primary" @onclick:stopPropagation @onclick="() => ShowReconvert(item)">Edit</button>
                    <button type="button" class="btn btn-sm btn-outline-danger" @onclick:stopPropagation @onclick="() => ConfirmDelete(item)">Delete</button>
                </div>
                <img src="/library-image/@item.SourceFileName" alt="@item.Name" style="max-width:64px; max-height:64px; border-radius:8px; box-shadow:0 1px 8px #0002; background:#eee;" />
                <div>
                    <strong style="font-size:1em; color:#222;">@item.Name</strong><br />
                    <span>Relative Brightness: @item.RelativeBrightness%</span>
                </div>
            </li>
        }
    </ul>
}

@code {
    private IReadOnlyList<PlayableItem>? items;

    protected override void OnInitialized()
    {
        LibraryService.ItemsChanged += OnItemsChanged;
        items = LibraryService.Items;
    }

    private void OnItemsChanged()
    {
        items = LibraryService.Items;
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        LibraryService.ItemsChanged -= OnItemsChanged;
    }

    private async Task ConfirmDelete(PlayableItem item)
    {
        var ok = await JSRuntime.InvokeAsync<bool>("confirm", $"Delete library item '{item.Name}' and its files?");
        if (ok)
        {
            LibraryService.DeleteLibraryItem(item);
        }
    }

    // ReConvert flow (use EditPlayableItemForm; service will handle reconvert)
    private bool showEditDialog = false;
    private PlayableItem? _originalItem;
    private PlayableItem? _editingClone;
    private EditPlayableItemForm? editFormRef;

    private void ShowReconvert(PlayableItem item)
    {
        _originalItem = item;
        _editingClone = item.Clone();
        showEditDialog = true;
    }

    private async Task OnOptionsOk()
    {
        showEditDialog = false;
        _editingClone = null;
        _originalItem = null;
        if (editFormRef is not null)
            await editFormRef.UnlockScrollAsync();
    }

    private async Task OnSaveLibraryItem((int editingIndex, PlayableItem updatedItem, PlayableItemFormMode formMode) args)
    {
        if (_originalItem is null) return;
        await LibraryService.OnEditFormSubmit(_originalItem, args.updatedItem, args.formMode);
        showEditDialog = false;
        _editingClone = null;
        _originalItem = null;
        if (editFormRef is not null)
            await editFormRef.UnlockScrollAsync();
        await InvokeAsync(StateHasChanged);
    }
}

@if (showEditDialog && _editingClone is not null && _originalItem is not null)
{
    <div style="position:fixed; z-index:9999; inset:8% 10%; display:flex; align-items:flex-start; justify-content:center;">
        <div style="width:80%;">
            <EditPlayableItemForm @ref="editFormRef"
                EditingItem="_editingClone"
                EditingIndex="0"
                ItemType="PlayableItemType.LIBRARY"
                FormMode="PlayableItemFormMode.LIBRARY"
                ImageUrl="@($"/library-image/{_originalItem.SourceFileName}")"
                OnSave="OnSaveLibraryItem"
                OnCancel="OnOptionsOk" />
        </div>
    </div>
}
