@using WearWare.Services.OperationProgress
@inject IOperationProgressService OperationProgressService
@rendermode InteractiveServer

<div class="mw-progress-overlay" hidden="@(!_visible)">
    <div class="mw-progress-card">
        <div class="mw-progress-title">@(_current.Title)</div>
        <div class="mw-progress-message">@(_current.Message)</div>
        @if (_current.IsCompleted && !_current.Success)
        {
            <div class="mw-progress-actions">
                <button class="mw-btn-ok" @onclick="Acknowledge">OK</button>
            </div>
        }
    </div>
</div>

@code {
    private OperationProgressEvent _current = new OperationProgressEvent();
    private bool _visible;
    private bool _acknowledged;

    protected override void OnInitialized()
    {
        OperationProgressService.OnProgressChanged += HandleProgress;
    }

    private void HandleProgress(OperationProgressEvent ev)
    {
        _current = ev;
        if (!ev.IsCompleted)
        {
            // New/ongoing operation: ensure visible and reset acknowledgement
            _acknowledged = false;
            _visible = true;
        }
        else
        {
            // Completed: if success, auto-hide; if failure, remain visible until user acknowledges
            if (ev.Success)
            {
                _visible = false;
            }
            else
            {
                _visible = true;
                _acknowledged = false;
            }
        }
        InvokeAsync(StateHasChanged);
    }

    private void Acknowledge()
    {
        _acknowledged = true;
        _visible = false;
        _current = new OperationProgressEvent();
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        OperationProgressService.OnProgressChanged -= HandleProgress;
    }
}
