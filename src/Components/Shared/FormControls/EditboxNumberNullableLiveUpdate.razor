@* Input number component that supports nullable ints and validates on input *@
@inherits InputBase<int?>

<input type="number" @attributes="AdditionalAttributes"
    class="@CssClass"
    value="@(CurrentValueAsString ?? string.Empty)"
    @oninput="HandleInput" />
@if (AddFocusGrabber){
    <FocusGrabber/>
}

@code {
    [Parameter]
    public EventCallback<int?> OnInput { get; set; }
    [Parameter]
    public bool AddFocusGrabber { get; set; } = false;

    private async Task HandleInput(ChangeEventArgs e)
    {
        CurrentValueAsString = e?.Value?.ToString() ?? string.Empty;

        int? parsedValue = null;
        if (!string.IsNullOrWhiteSpace(CurrentValueAsString) && int.TryParse(CurrentValueAsString, out var p))
        {
            parsedValue = p;
        }

        if (OnInput.HasDelegate)
        {
            await OnInput.InvokeAsync(parsedValue);
        }
        // Trigger validation immediately while typing
        EditContext?.Validate();
    }

    #pragma warning disable CS8765
    protected override bool TryParseValueFromString(string? value, out int? result, out string? validationErrorMessage)
    {
        validationErrorMessage = null;
    #pragma warning restore CS8765
        if (string.IsNullOrWhiteSpace(value))
        {
            result = null;
            return true;
        }

        if (int.TryParse(value, out var parsed))
        {
            result = parsed;
            return true;
        }

        if (long.TryParse(value, out var parsedLong))
        {
            if (parsedLong > int.MaxValue) { validationErrorMessage = "Now that's just silly :)"; }
        }
        result = null;
        return false;
    }
}
