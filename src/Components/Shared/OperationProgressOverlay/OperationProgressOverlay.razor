@using WearWare.Services.OperationProgress
@using System.Threading.Tasks
@inject IOperationProgressService OperationProgressService
@rendermode InteractiveServer

<div class="mw-progress-overlay" hidden="@(!_visible)">
    <div class="mw-progress-card">
        <div class="mw-progress-title">@(_current.Title)</div>
        <div class="mw-progress-message">
            @if (_current.Steps != null && _current.Steps.Count > 0)
            {
                <ul class="mw-progress-steps">
                    @foreach (var s in _current.Steps)
                    {
                        <li>@s</li>
                    }
                </ul>
            }
            else
            {
                <div>@(_current.Message)</div>
            }
        </div>
        @if (_current.IsCompleted && !_current.Success)
        {
            <div class="mw-progress-actions">
                <button class="mw-btn-ok" @onclick="Acknowledge">OK</button>
            </div>
        }
    </div>
</div>

@code {
    private OperationProgressEvent _current = new OperationProgressEvent();
    private bool _visible;

    protected override void OnInitialized()
    {
        OperationProgressService.OnProgressChanged += HandleProgress;
    }

    private void HandleProgress(OperationProgressEvent ev)
    {
        _current = ev;
        if (!ev.IsCompleted)
        {
            // New/ongoing operation: ensure visible
            _visible = true;
        }
        else
        {
            // Completed: if success, show final message briefly then hide; if failure, remain visible until user acknowledges
            if (ev.Success)
            {
                // Keep overlay visible for a short time so user can read final message
                _visible = true;
                var opId = ev.OperationId;
                _ = Task.Run(async () =>
                {
                    await Task.Delay(500);
                    // Only hide if the operation is still the same completed success
                    if (_current.OperationId == opId && _current.IsCompleted && _current.Success)
                    {
                        _visible = false;
                        _current = new OperationProgressEvent();
                        await InvokeAsync(StateHasChanged);
                    }
                });
            }
            else
            {
                _visible = true;
            }
        }
        InvokeAsync(StateHasChanged);
    }

    private void Acknowledge()
    {
        _visible = false;
        _current = new OperationProgressEvent();
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        OperationProgressService.OnProgressChanged -= HandleProgress;
    }
}
